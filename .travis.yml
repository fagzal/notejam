sudo: required
language: php
php:
 - 5.6
services:
  - docker

before_install:
 - curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
 - unzip awscli-bundle.zip
 - ./awscli-bundle/install -b ~/bin/aws
 - export PATH=~/bin:$PATH
 - ./aws_credentials.sh
 - export PATH=$PATH:$HOME/.local/bin
 - aws rds   describe-db-instances --db-instance-identifier aurorac --query 'DBInstances[0].Endpoint.Address'
 - cd laravel/notejam
 - composer install 
 - cd ../../
 - docker build -f docker/Dockerfile_apache -t notejam:latest .
 - docker run --name notejam_container -d -p 80:80 notejam:latest
 - docker ps -a

script:
- docker exec -t notejam_container bash -c "/usr/local/bin/php /var/www/html/vendor/bin/phpunit"

before_deploy: "./createbundle.sh"

deploy:
 - provider: s3
   access_key_id: $AWS_ACCESS_KEY_ID
   secret_access_key: $AWS_SECRET_ACCESS_KEY
   bucket: "notejam"
   region: us-east-2
   local_dir: build
   skip_cleanup: true
   on:
     branch: travisci
 - provider: codedeploy
   access_key_id: $AWS_ACCESS_KEY_ID
   secret_access_key: $AWS_SECRET_ACCESS_KEY
   bucket: "notejam"
   key: build/bundle.zip
   application: testapp
   region: us-east-2
   deployment_group: newdpg 
   on:
     branch: travisci
